template.helper('thumbUrl', function (pid) {
    var url = (pid % 50) + '/' +pid+'_thumb.jpg';
    return url;
});
var optshtml = '<option value="-1">请选择</option>' +
    '{{each options as option}}' +
    '<option value="{{option.region_id}}">{{option.region_name}}</option>' +
    '{{/each}}';
$(document).ready(function() {

    $(".toTime").each(function(idx, val) {
        var timestamp = $(val).text();
        $(val).text(moment.unix(timestamp).format('YYYY-MM-DD'));
    });
    $("#activate-bonus").click(function(){
        var bonus_code = $.trim($("#bonusCodeInput").val());
        if (bonus_code === '' || bonus_code == undefined) {
            return;
        }
        var postdata = {
            bonus_code: bonus_code
        }
        var selectedBonus = parseInt($("#bonus_id").val());
        $.post(appUrl + "/Flow/activateBonus", postdata, function(res) {
            if (res.code == 0) {
                $("#bonusList").html(res.html)
                formatTime();
                res.msg = "激活成功";
                // if (selectedBonus > 0) $(".bonus-btn-"+selectedBonus).addClass('disabled').text('已使用');
            }
            alertify.alert(res.msg).set({'title':'','label':'确定'});
            $("#bonusCodeInput").val('');
        }, 'JSON');
    });
    $("#activate-giftcard").click(function(){
        var gc_key = $.trim($("#giftCardCodeInput").val());
        if (gc_key === '' || gc_key == undefined) {
            return;
        }
        var postdata = {
            gc_key: gc_key
        }
        $.post(appUrl + "/Flow/activateGiftCard", postdata, function(result) {
            if (result.code == 0) {
                document.getElementById('giftCardList').innerHTML = template('giftCardListTpl', result);
                result.msg = "激活成功";

            }
            alertify.alert(result.msg).set({'title':'','label':'确定'});
            $("#giftCardCodeInput").val('');
        }, 'JSON');
    })
    $('#mobile').change(function() {
        var mobile = $(this).val();
        res = isMobile_Email(mobile)
        if (res == false) {
            //$('#mobile').val('');
        };
    })

    $('#email').change(function() {
        var email = $(this).val();
        res = isMobile_Email(email)
        if (res == false) {
            //$('#email').val('');
        };
    })


    $("#kqPay").attr("target", "_blank");

    $('#provinces').change(function() {
        //alert($(this).children('option:selected').val()); 
        var prov_id = $(this).children('option:selected').val(); //这就是selected的值 
        $.get(appUrl + "/Usercenter/ajaxCityList?rid=" + prov_id, function(res) {
            $("#cities").html(res);
            $("#districts").html('');
        }, 'JSON');
    })


    $('#cities').change(function() {
        //alert($(this).children('option:selected').val()); 
        var city_id = $(this).children('option:selected').val(); //这就是selected的值 
        $.get(appUrl + "/Usercenter/ajaxDistrictList?rid=" + city_id, function(res) {
            $("#districts").html(res);
        }, 'JSON');
    })

    $('#save_user_address').click(function() {
        save_user_address();
    })

    $('#update_user_address').click(function() {
        update_user_address();
    });

    $("#mail-nickname").bind('blur keyup', function() {
        var nickname = $.trim($(this).val());
        $("#invite-from").text(nickname);
    });
    $("#validateVoucher").click(function() {
        var sn = $("#vouchersn").val();
        var verify = $("#verify").val();
        if ($.trim(sn) == '') {
            openDialog('', '请输入提货券号码');
            return;
        }
        var url = appUrl + "/RetailCoupon/validate";
        var postdata = {
            vsn: sn,
            verify: verify
        }
        $.post(url, postdata, function(result) {
            if (result.code == 0) {
                openDialog(
                    '验证通过',
                    '该提货券码可兑换:' + result.msg,
                    '暂不兑换',
                    function() {
                        $("#verify").val('');
                        updateVerify();
                    },
                    '立刻兑换',
                    function() {
                        $("#exchangeVoucher").submit();
                    }
                );
            } else {
                openDialog('', result.msg);
            }

        }, "JSON");

    })
    $('#cartconnect').on('keydown', '.bigcart_num', function(e) {
        if (e.keyCode < 48 || (e.keyCode > 57 && e.keyCode < 96) || (e.keyCode > 105 && e.keyCode < 112) || e.keyCode > 123) {

            switch (e.keyCode) {
                case 13:
                    e.keyCode = 9;
                case 8:
                case 9:
                case 10:
                case 17:
                case 18:
                case 20:
                case 33:
                case 34:
                case 35:
                case 36:
                case 37:
                case 38:
                case 39:
                case 40:
                case 45:
                case 46:
                case 91:
                case 92:
                case 93:
                case 127:
                case 144:
                    return true;
                default:
                    return false;
            }
        }

    });
    $('#cart_main').on('keydown', '.product_num', function(e) {
        // openDialog('',e.keyCode);
        if (e.keyCode < 48 || (e.keyCode > 57 && e.keyCode < 96) || (e.keyCode > 105 && e.keyCode < 112) || e.keyCode > 123) {

            switch (e.keyCode) {
                case 13:
                    e.keyCode = 9;
                case 8:
                case 9:
                case 10:
                case 17:
                case 18:
                case 20:
                case 33:
                case 34:
                case 35:
                case 36:
                case 37:
                case 38:
                case 39:
                case 40:
                case 45:
                case 46:
                case 91:
                case 92:
                case 93:
                case 127:
                case 144:
                    return true;
                default:
                    return false;
            }
        }

    });
    $("#use-gift-card").click(function() {
        var selectedCard = new Array();
        $("input:checkbox[name='giftCardId[]']").each(function() {
            if ($(this).prop('checked') == true) {
                selectedCard.push($(this).val());
            }
        });
        var postdata = {
            card: selectedCard
        }
        $.post(appUrl + '/Flow/selectCard', postdata, function(result) {
            dealDeductInfo(result);
            updateFeeSummary(result);
            $("#giftcard_main").hide();
            $("#giftcard_img").removeClass("toggle_title_img_hover");
        }, 'JSON');
    });

    $("#bonusList").on('click','.use-bonus',function() {
        if ($(this).hasClass('disabled')) {
            return;
        }
        var bonus_id = $(this).attr('bid');
        selectBonus(bonus_id);
    });
    $(".unuse-bonus").click(function() {
        selectBonus(0);
    });

    if ($("#new_address_radio").prop('checked')) {
        newAddress();
    }
    //选择在线支付的话，自动选择第一家
    $('#pay_ment').on('click', '#pay_online', function() {
        $('input:radio[rel=payment]').eq(0).prop('checked', true);
    });
    //选择在线支付下的支付银行的话自动选择在线支付按钮
    $('#pay_ment').on('click', 'input:radio[rel=payment]', function() {
        $('#pay_online').prop('checked', true);
    });

    //选择货到付款的话，取消在线支付按钮的选择
    $("#pay_ment").on('click', '#pay_receipt', function() {
        $('#pay_online').prop('checked', false);
    })

    //选择余额支付的话，取消在线支付按钮的选择
    $("#pay_balance").click(function() {
        $('input:radio[name=pay_online]').prop('checked', false);
    });

    //修改收货人信息
    $(document).on('click', '#address_change', function() {
        $("#consignee_list_radio,#save_to_address,#save_conignee_before").show();
        $("#address_change,#save_to_payment,#payment_change,#address_abstract").hide()
        $("#hgs_consignee").attr("class", "choice_this");
    });
    //点击保存配送及支付方式
    /* $("#save_to_payment").click(function() {
     check_payment();
     })*/
    $(document).on("click", "#save_to_payment", function() {
        check_payment();
    });
    //修改支付及配送方式
    $(document).on("click", "#payment_change", function() {
        $("#pay-ship-info,#save_to_payment,#address_text_save").show();
        $("#payment_ship_text,#payment_change,#address_change,#save_to_address").hide();
        $("#pay_ment").attr("class", "choice_this")
    });
    //点击保存收货人信息new_address_radio
    $(document).on("click", "#new_address_radio", function() {
        newAddress();
    });
    //选择已有的单选框按钮
    $(document).on('click', '.user_consignee_list', function() {
        $("#new_address_main,#save_address").hide();
        $("#set_address").show();
    });
    $(document).on('click', '#save_address', function() {
        save_consignee();
    });
    //点击保存 保存收货人信息
    $(document).on('click', '#save_to_address', function() {
        if ($("#new_address_radio").prop('checked')) {
            save_consignee();
        } else {
            setAddress();
        }
    });


    $("input:radio[name=inv_need_addr]").click(function() {
        if ($(this).val() == 0) {
            $("#receipt_address").hide();
        } else {
            $("#receipt_address").show();
        }
        invoiceNeedShipping();
    });

    $("#onlinepay_btn").bind('click', function(e) {
        $("#onlinepay_btn form").submit();
    });
    $("#order_amount").bind('keydown', function(e) {
        if (e.keyCode < 48 || (e.keyCode > 57 && e.keyCode < 96) || (e.keyCode > 105 && e.keyCode < 112) || e.keyCode > 123) {

            switch (e.keyCode) {
                case 13:
                    e.keyCode = 9;
                case 8:
                case 9:
                case 10:
                case 17:
                case 18:
                case 20:
                case 33:
                case 34:
                case 35:
                case 36:
                case 37:
                case 38:
                case 39:
                case 40:
                case 45:
                case 46:
                case 91:
                case 92:
                case 93:
                case 127:
                case 144:
                    return true;
                default:
                    return false;
            }
        }
    });

    $("#tb_search").bind("keydown", function(e) {
        if (e.keyCode == 13 || e.which == 13 || e.charCode == 13) {
            search();
        }
    });

    //$("#btn_search").bind("click", search);
    Resize();
    $(window).resize(function() {

        Resize();
    })
    $("img.lazy").lazyload({
        threshold: 200
    });

    $(window).scroll(function() {
        if ($(window).scrollTop() > 121) {
            $(".hgs_nav_main").css({
                "position": "fixed",
                "top": 0 + "px",
                "left":0 +"px"
            });
            $("#gotopbtn").show();
        } else {
            $(".hgs_nav_main").css({
                "position": ""
            });
            $("#gotopbtn").hide();
        }
    })
    //搜索框默认
    $("#tb_search").val($("#default_search").text());
    $("#tb_search").click(function() {
        if ($(this).val() == $("#default_search").text()) {
            $(this).val("");
            //$(this).css(
            //    "color", "#000"
            //)
        }
    })

    // //邀请码
    // $(".invitation_system").click(function() {
    //     if ($(this).val() == "如有邀请码，请输入") {
    //         $(this).val("");
    //         $(".invitation_system").css(
    //             "background-color", "#fff"
    //         )
    //     }
    // });
    // $(".invitation_system").blur(function() {
    //     if ($(this).val() == "") {
    //         $(this).val("如有邀请码，请输入");
    //         $(".invitation_system").css(
    //             "background-color", "#F4F4F4"
    //         )
    //     }
    // });
    $("#tb_search").blur(function() {
        if ($(this).val() == "") {
            $(this).val($("#default_search").text());
            //$(this).css(
            //    "color", "#ccc"
            //)
        }
    })


    $(".daily_check_in").click(function() {
        checkIn();
    })
    // $('.change_city_name span').text(function() {
    //   return $('.sitelist.selected').text();
    //});

    //微信扫一扫
    $(".wechat").mouseover(function() {
        $(".wechat_icon").show();
    }).mouseout(function() {
        $(".wechat_icon").hide();
    });

    $("#login_form").Validform({
        tiptype: 1,
        ajaxPost: true,
        beforeSubmit:function(curform){
    		//在验证成功后，表单提交前执行的函数，curform参数是当前表单对象。
    		//这里明确return false的话表单将不会提交;	
        	var html = $("input[name='login_password']").val();
        	var md5_html = hex_md5(html);
        	$("input[name='login_password']").val(md5_html);
    	},
        callback: function(data) {
            signInResponse(data);
        },
       tiptype:function(msg,o,cssctl){
			if(!o.obj.is("form")){
				
			}else{
				var objtip=o.obj.parent().find("#errortext");
				//cssctl(objtip,o.type);	//和原来的样式冲突，取消
				objtip.text(msg);
			}
		}
    });

    $("#subscribe_form").Validform({
        btnSubmit: "#subscribe",
        tiptype: 4,
        ajaxPost: true,
        tipSweep: true,
        dragonfly: true,
        beforeSubmit: function(curform) {
            if ($("#subscribe_mail").val() == '') return false;
        },
        callback: function(data) {
            var tip = $("#subscribe_form").find('.Validform_checktip');
            if (data.code == 0) {
                tip.text('订阅成功');
            } else {
                tip.text('您已经订阅过,无需重复订阅');
            }
            setTimeout(function() {
                tip.text('');
            }, 3000);
        }
    });


    var registerForm = $("#register_form").Validform({
        tiptype: 1,
        ajaxPost: true,
        usePlugin: {
            jqtransform: {
                //会在当前表单下查找这些元素;
                selector: "select,:checkbox,:radio,.decorate"
            }
        },
        beforeSubmit:function(curform){
    		//在验证成功后，表单提交前执行的函数，curform参数是当前表单对象。
    		//这里明确return false的话表单将不会提交;	
        	var html = $("input[name='register_password']").val();
        	var md5_html = hex_md5(html);
        	$("input[name='register_password']").val(md5_html);
    	},
        callback: function(data) {
            registerResponse(data);
        },
        tiptype:function(msg,o,cssctl){
			//msg：提示信息;
			//o:{obj:*,type:*,curform:*}, obj指向的是当前验证的表单元素（或表单对象），type指示提示的状态，值为1、2、3、4， 1：正在检测/提交数据，2：通过验证，3：验证失败，4：提示ignore状态, curform为当前form对象;
			//cssctl:内置的提示信息样式控制函数，该函数需传入两个参数：显示提示信息的对象 和 当前提示的状态（既形参o中的type）;
			if(!o.obj.is("form")){//验证表单元素时o.obj为该表单元素，全部验证通过提交表单时o.obj为该表单对象;
				var objtip=o.obj.parent().siblings(".Validform_checktip");
				cssctl(objtip,o.type);
				objtip.text(msg);
			}else{
				var objtip=o.obj.parent().find(".validmsg");
				cssctl(objtip,o.type);
				objtip.text(msg);
			}
		}
    });
    var forgetPasswordForm = $("#forget-password").Validform({
        tiptype: 2,
        ajaxPost: true,
        callback: function(data) {
            forgetPasswordResponse(data);
        }
    });


    var validateEmailForm = $("#validateEmail").Validform({
        tiptype: 4,
        ajaxPost: true,
        callback: function(data) {
            openDialog('验证邮箱', '邮件发送成功！请进入您的邮箱查收邮件并激活！', '确定', function() {
                if (data.code == 0) {
                    window.location.href = appUrl + "/Usercenter/userinfo";
                }
            });
        }
    });
    var validateMobileForm = $("#validateMobile").Validform({
        tiptype: 4,
        ajaxPost: true,
        callback: function(data) {

            openDialog('验证手机', data.msg, '确定', function() {
                if (data.code == 0) {
                    window.location.href = appUrl + "/Usercenter/userinfo";
                }
            });

        }
    });
    var cpFeedbackFrom = $("#feedback").Validform({
        tiptype: 4,
        ajaxPost: true,
        callback: function(data) {
            switch (data.code) {
                case 0:
                    openDialog('', "您的反馈已提交,我们会尽快处理！");
                    cpFeedbackFrom.resetForm();
                    break;
                case -1:
                    openDialog('', "验证码错误");
                    break;
            }
            updateVerify();
        }

    });

    var cpOrderFrom = $("#cp-order").Validform({
        tiptype: 4,
        datatype: {
            "phone": function(gets, obj, curform, regxp) {
                var reg1 = regxp["m"],
                    reg2 = /(^(([0\+]\d{2,3}-)?(0\d{2,3})-)(\d{7,8})(-(\d{3,}))?$)|(^0{0,1}1[3|4|5|6|7|8|9][0-9]{9}$)/,
                    mobile = curform.find("#mobile");

                if (reg1.test(mobile.val())) {
                    return true;
                }
                if (reg2.test(gets)) {
                    return true;
                }

                return false;
            }
        },
        ajaxPost: true,
        callback: function(data) {
            switch (data.code) {
                case 0:
                    openDialog('提交成功', "您的采购需求已提交成功,我们会尽快联系您!");
                    cpOrderFrom.resetForm();
                    break;
                case -1:
                    openDialog('', "验证码错误");
                    break;
            }
            updateVerify();
        }

    });
    var commentForm = $("#commentForm").Validform({
        tiptype: 4,
        ajaxPost: true,
        callback: function(data) {
            switch (data.code) {
                case 0:
                    window.location.href = appUrl + '/Usercenter/commentList';
                    break;
                case -1:
                    openDialog('', "验证码错误");
                    break;
            }
            updateVerify();
        }

    });


    //商品详情页面小图切大图
    $(".product_lit_img .product_lit_imgs").each(function(){
        $(this).click(function() {
            var originUrl = $(this).attr('origin');
            $(".product_lit_img").children().removeClass('hover');
            $(this).addClass('hover');
            $(".product_big_img").children("img").attr("src",originUrl);
        });
    })

    //循环ICON字体
    var abc=["","&#xe600;","&#xe61b;","&#xe61a;"];
    $(".index_title_item_left .icon-newfruit").each(function(){
        var a=$(this).attr("k");
        $(this).html(abc[a]);
    })
    //lazyload
    $("img").lazyload({
        threshold: 300
    });
    $("img").lazyload({
        placeholder: "Js/lazyload/grey.gif",
        effect: "fadeIn"
    });
    //推荐商品加入购物车
    $("body").on('click','.need_login',function() {
        url = this.href;
        login(url);
        return false;
    });

    $(".a_style").click(function() {
        $(".product_tab").find('li').eq(1).click();
    });

    //根据轮播图数量加载按钮个数。
    var bannerNum = $(".banner_list a").size();
    var btnList = "";
    for (var i = 0; i < bannerNum; i++) {
        btnList = btnList + (i == 0 ? '<span class="hover"></span>' : '<span class=""></span>');
    }
    $(".lunbo_btn").append(btnList);
    $(".collect_hgs").mouseover(function() {
        $(".collect_hgs b").addClass("hover");
    }).mouseout(function() {
        $(".collect_hgs b").removeClass("hover");
    })
    // $(".custom_service").mouseover(function() {
    //     var a = 'zhaoshou';
    //     $(".custom_service img").attr("src", appUrl + "/Tpl/Public/Images/" + a + ".gif");
    // }).mouseleave(function() {
    //     var a = 'zhayan';
    //     $(".custom_service img").attr("src", appUrl + "/Tpl/Public/Images/" + a + ".gif");
    // })

    $(".my_hgs").mouseover(function() {
        $(".my_hgs span").show();
        $(".my_hgs b").addClass("hover");
        $(".blank_box").show();
        $(".my_hgs_down").show();
    }).mouseout(function() {
        $(".my_hgs span").hide();
        $(".my_hgs b").removeClass("hover");
        $(".blank_box").hide();
        $(".my_hgs_down").hide();
    })



    $(document).bind("click",function(e){
        var target = $(e.target);
        if(target.closest(".change_city_blank").length == 0){
            $(".change_city_name").removeClass("hover");
            $(".change_city_item").hide();
            $(".city_list_close").hide();
        }
    }) 

    $(".change_city_blank").mouseover(function() {
        $(".change_city_name").addClass("hover");
        $(".change_city_item").show();
        $(".city_list_close").show();
    }) 

    $(".city_list_close").click(function() {
        $(".change_city_name").removeClass("hover");
        $(".change_city_item").hide();
        $(".city_list_close").hide();
    });

    $(".micro_blog").mouseover(function() {
        $(".abs_weixin_icon").show();
    }).mouseout(function() { 
        $(".abs_weixin_icon").hide();
    })

    //提示邮费信息选择
    //var cityName=$("#cityName").text();
    //if(cityName=="6"){
    //$("#postage_txt").text("深圳地区满99元免运费");
    //}else {
    //$("#postage_txt").text("购物满118元免运费");
    //}
    //登录注册获得焦点事件
    $("#user_name").click(function() {
        if ($(this).val() == "手机/邮箱") {
            $(this).val("");
            $(this).css("color", "#000");
        }
    })
    $("#user_name").blur(function() {
        if ($(this).val() == "") {
            $(this).val("手机/邮箱");
            $(this).css("color", "#CBCBCB");
        }
    })

    $("#register_name").click(function() {
        if ($(this).val() == "手机/邮箱") {
            $(this).val("");
            $(this).css("color", "#000");
        }
    })
    $("#register_name").blur(function() {
        if ($(this).val() == "") {
            $(this).val("手机/邮箱");
            $(this).css("color", "#CBCBCB");
        }
    })

    $("#findpass_name").click(function() {
        if ($(this).val() == "手机/邮箱") {
            $(this).val("");
            $(this).css("color", "#000");
        }
    })
    $("#findpass_name").blur(function() {
        if ($(this).val() == "") {
            $(this).val("手机/邮箱");
            $(this).css("color", "#CBCBCB");
        }
    })

    $("#user_validate").click(function() {
        if ($(this).val() == "请输入验证码") {
            $(this).val("");
            $(this).css("color", "#000");
        }
    })
    $("#user_validate").blur(function() {
        if ($(this).val() == "") {
            $(this).val("请输入验证码");
            $(this).css("color", "#CBCBCB");
        }
    })

    $("#user_invitation").click(function() {
        if ($(this).val() == "选填，邀请码注册即可获得1000积分") {
            $(this).val("");
            $(this).css("color", "#000");
        }
    })
    $("#user_invitation").blur(function() {
        if ($(this).val() == "") {
            $(this).val("选填，邀请码注册即可获得1000积分");
            $(this).css("color", "#CBCBCB");
        }
    })

    $("#find_pass_validate").click(function() {
        if ($(this).val() == "请输入验证码") {
            $(this).val("");
            $(this).css("color", "#000");
        }
    })
    $("#find_pass_validate").blur(function() {
        if ($(this).val() == "") {
            $(this).val("请输入验证码");
            $(this).css("color", "#CBCBCB");
        }
    })


    //选仓效果
    $(".storehouse_city").mouseover(function() {
        var storehouse = $(this).parent().parent().find(".storehouse_title").text();
        var city = "";
        switch(storehouse){
            case '北京仓：':
                city = 'beijing';
                break;
            case '上海仓：':
                city = 'shanghai';
                break;
            case '成都仓：':
                city = 'chengdu';
                break;
            case '武汉仓：':
                city = 'wuhan';
                break;
            case '深圳仓：':
                city = 'shenzhen';
                break;                                
        }
        $(".change_city_prompt img").attr("src", appUrl + "/Tpl/Public/Images/"+city+"_city.jpg")

    })

    $(".follow_package_main").mouseenter(function(){
        var traceLine = $(this);
        var serialNum = traceLine.attr('logsn');
        var sfQueryUrl = 'http://www.sf-express.com/sf-service-web/service/bills/'+serialNum+'/routes?app=bill&lang=sc&region=cn';
        if (!traceLine.hasClass('tracked')) {
            traceLine.addClass('tracked');
            $.get(sfQueryUrl,function(result){
                if (result.length < 1) {
                    traceLine.removeClass('tracked');                    
                } else {
                    var traceHTML = template('LogisticsInfo',result[0]);
                    traceLine.find('table').append(traceHTML);                    
                }
            })
            // $.get(appUrl+'/Usercenter/getLogisticsInfo',{logisticsSerial:serialNum},function(result){
            //     if (result.status == 'OK') {
            //         var traceHTML = template('LogisticsInfo',result);
            //         traceLine.find('table').append(traceHTML);
                    
            //     } else {
            //         traceLine.removeClass('tracked');
            //     }
            // })
            
        }
    })
    //选择城市，显示城市所在仓的货品列表
    $(".storehouse_city").click(function() {
        var siteId = $(this).attr('siteId');
        var url = appUrl + "/Users/setSite/siteId/" + siteId;
        $.get(url, function() {
            location.reload();
        });
    })

    $(".change_city_name > span").text(function() {
        return $('.storehouse_city.hover').text();
    })


    //导航 
    $(".hgs_nav li").hover(function() {
        $(this).toggleClass("hover");
    })

    var timer = null;
    $("#cart_main").hover(
            function(){
                
                timer=setTimeout(function(){
                    $("#cart_main").animate({width:"372px"});   
                    $(".minicart").slideDown("slow");
                },200);
            },
            function(){
                if(timer){
                    clearTimeout(timer);
                }
    });

    $("#cart_main").mouseleave(function(){
        $(this).animate({width:"302px"},200);
        $(".minicart").hide();


    })

    $(".sea_title div").each(function(i){
        var y=i+1;
        $(this).click(function() {
            if ($(".sea_js_"+y).length == 1) {
                $(".sea_title div").removeClass('hover');
                $(this).addClass('hover'); 
                $(".sea_tuijian").hide();
                $(".icon-sea").hide();
                $(".sea_title_"+y).show();
                $(".sea_js_"+y).show();
            }
        });
    })

   


    // //迷你购物车
    // var timer = null;
    // $("#cart_main").hover(function() {
    //     timer=setTimeout(function(){ 
    //          $("#cart_main").animate({width:"372px"});

    //     },500,minicart_show);
    
    // },function(){
    //     if(timer)  
    //         clearTimeout(timer);
    //     });
    // }).mouseleave(function() {
    //     $(this).animate({width:"302px"},500,minicart_hide);
    // })

    //个人中心左导航
    $(".user_item_title").click(function() {
        $(this).siblings().toggle();
        $(this).toggleClass("user_item_title_click");
    })
    //个人中心跟踪包裹
    // $(".follow_package_main").hover(function() {
    //     $(".follow_package_detailed", this).toggle();
    //     $(".follow_package_blank", this).toggle();
    //     $('.follow_package', this).toggleClass("follow_package_click");
    // })

    //评论星星
    $(".write_conment_img_btn").each(function(i) {
        var y = i + 1;
        $(this).click(function() {
            $("#conment_bgimg").attr("class", "write_conment_bgimg_" + y);
            $("#rank").val(y);
        })
    })

    //tab
    $(".affiliate-tab").children().hide();
    $(".affiliate-tab").children().eq(0).show();
    $(".js-tab-control").each(function(i) {
        $(this).click(function() {
            if (!$(this).hasClass("hover")) {
                $(this).addClass("hover").siblings().removeClass("hover");
                $(".affiliate-tab").children().eq(i).show().siblings().hide();
            }
        })
    })
    //flow 优惠三部曲显示弹窗
    $(".toggle_mouseover").each(function(i) {
        var y = i + 1;
        $(this).click(function() {
            $(".toggle_title_img", this).toggleClass("toggle_title_img_hover");
            if (y == 1) {
                $("#bonus_main").toggle();
            }
            if (y == 2) {
                $("#giftcard_main").toggle();
            }
            if (y == 3) {
                $("#integral_main").toggle();
            }
            if (y == 4) {
                $("#receipt_main").toggle();
            }
        })
    })

    //判断配送区域
    $("#selDisctricts").change(function() {
        var checkText = $("#selDisctricts").find("option:selected").text();
        if (checkText == "大明湖") {
            alert("将在两个小时内送达");
        }
    });

    //发票 单选框
    $("#receipt_yes").click(function() {
        $("#receipt_pack").show();

    })

    $("#receipt_no").click(function() {
        $("#receipt_address_no").prop('checked', true).click();
        $("#receipt_pack").hide();
    })

    $("#receipt_address_yes").click(function() {
        $("#receipt_address").show();
    })


    $("#receipt_address_no").click(function() {
        $("#receipt_address").hide();
    })

    //商品详情配送地址
    $(".deliver_item_bottom li").each(function(i) {
        $(this).click(function() {
            goods_address_tab(i);
            $(".area_list").children().hide();
            $(".area_list").children().eq(i).show();
        })
    })

    function goods_address_tab(i) {
        $(".deliver_item_bottom li").attr("class", "deliver_item_bottom_li");
        $(".deliver_item_bottom li").eq(i).attr("class", "deliver_item_bottom_li_hover");
    }

    $("#gotopbtn").hide();


    $(".font_info_img").hover(function(){
        $(this).children().show();
    }).mouseleave(function() {
        $(".abs_info_img").hide();
    });

    $(".woshan").hover(function(){
        $(".abs_woshan").show();
    }).mouseleave(function() {
       $(".abs_woshan").hide();
    });

    $(".product_right_erweima").hover(function(){
        $(".abs_erweima").show();
    }).mouseleave(function() {
        $(".abs_erweima").hide();
    });


    //当点击跳转链接后，回到页面顶部位置
    $("#gotopbtn").click(function() {
        $('body,html').animate({
            scrollTop: 0
        }, 300);
        return false;
    });

    // 商品详情页的省市区三级联动
    $(document).on('click', '.province', function() {

        $(".area_list").children().hide();
        $(".area_list").children().eq(1).show();
        goods_address_tab(1);
        var prov_id = $(this).attr('id');
        var prov_name = $(this).text();
        $("#province_id").val(prov_id);
        // 刷新省标题
        $("#user_province").text(prov_name);
        $.get(appUrl + "/Product/ajaxCityList?rid=" + prov_id, function(res) {
            $("#city_list").html(res);
            $("#district_list").html('');
            $('#user_city').html('请选择市');
            $('#user_district').html('请选择区');
            $('#district_id').val('');
        }, 'JSON');
    });
    $(document).on('click', '.city', function() {
        $(".area_list").children().hide();
        $(".area_list").children().eq(2).show();
        goods_address_tab(2);
        var city_id = $(this).attr('id');
        var city_name = $(this).text();
        // 刷新市标题
        $("#user_city").text(city_name);
        $("#city_id").val(city_id);
        $.get(appUrl + "/Product/ajaxDistrictList?rid=" + city_id, function(res) {
            $("#district_list").html(res);
            $("#user_district").click();
        }, 'JSON');
    });
    $(document).on('click', '.district', function() {

        $(".deliver_address_item").hide();
        $(".deliver_address_box_hover").attr("class", "deliver_address_box");
        var district_id = $(this).attr('id');
        var district_name = $(this).text();
        // 刷新区标题
        $("#user_district").text(district_name);
        // 刷新总标题
        var prov_name = $('#user_province').text();
        var city_name = $('#user_city').text();
        var dest_name = prov_name + city_name + district_name;
        $('#user_dest').text(dest_name);
        $("#district_id").val(district_id);

        $.get(appUrl + "/Product/saveUserAddressSelection?prov=" + $("#province_id").val() + "&city=" + $("#city_id").val() + "&district=" + $("#district_id").val(),
            function(pname) {

                $('#cityName').text(pname);
                $('div.storehouse_city.hover').removeClass('hover');
                $('div.storehouse_city:contains(' + pname + ')').addClass('hover');
                location.reload();

                //TODO 换全国地图
            });

    });


    /* $(".storehouse_city").click(function() {
     var siteId = $(this).attr('siteId');
     var url = appUrl + "/Users/setSite/siteId/" + siteId;
     $.get(url, function() {
     location.reload();
     });
     })
     */


    $(".deliver_address_left").mouseover(function() {
        $(this).children().eq(0).attr("class", "deliver_address_box_hover");
        $(this).children().eq(1).show();
    })
    //配送区域关闭按钮。
    $(".deliver_address_item_close").click(function() {
        $(".deliver_address_left").children().eq(0).attr("class", "deliver_address_box");
        $(".deliver_address_item").hide();
    })

    $(document).bind("click", function(e) {
        var target = $(e.target);
        if (target.closest(".deliver_address_item").length == 0) {
            $(".deliver_address_left").children().eq(0).attr("class", "deliver_address_box");
            $(".deliver_address_item").hide();
        }
    })
    
    //商品数量加减
    //+号按钮
    $(".product_num_add").click(function() {
        var num = parseInt($("#product_num").val()) + 1;
        num = num > 100 ? 100 : num;
        $("#product_num").val(num);
    })
    //-号按钮
    $(".product_num_del").click(function() {
        var num = parseInt($("#product_num").val()) - 1;
        num = num < 1 ? 1 : num;
        $("#product_num").val(num);
    })


    $("#product_num").keyup(function() {
        var num = parseInt($("#product_num").val());
        if (isNaN(num)) {
            $("#product_num").val(1);
        } else {
            if (num > 100 || num < 1) {
                $("#product_num").val(1);
            } else {
                $("#product_num").val(num);
            };
        };
    });


    $("#js_product_tab").children().hide();
    $("#js_product_tab").children().eq(0).show();
    $(".product_tab li").each(function(i) {
        $(this).click(function() {
            $(".product_tab li").removeClass("hover");
            $(this).addClass("hover");
            $("#js_product_tab").children().hide();
            $("#js_product_tab").children().eq(i).show();
        })
    })

    //登录注册页面

    //登录注册弹窗
    $(".login_register_btn").click(function() {
        $("#login_main").hide();
        $("#register_main").show();
    })

    $(".forget_pass").click(function() {
        $("#login_main").hide();
        $("#find_pass").show();
    })

    $(".register_login_btn").click(function() {
        $("#login_main").show();
        $("#register_main").hide();
    })

    $(".pop_title img").click(function() {
        $(".Popshow").hide();
        $("#bg").remove();
    })

    // // 关闭提示弹窗
    // $(".pop_btn").click(function() {
    //     $(".pop_main").hide();
    //     $("#bg").remove();
    // })
    //订阅邮箱提示
    $("#subscribe_mail").click(function() {
        if ($(this).val() == "请输入订阅邮箱") {
            $(this).val("");
        }
    })
    $("#subscribe_mail").blur(function() {
        if ($(this).val() == "") {
            $(this).val("请输入订阅邮箱");
        }
    })

    //商品详情二维码
    $(".sweep_icon").mouseover(function() {
        $(".sweep_big_img").show();
        $(".sweep_prompt").addClass("hover");
    }).mouseout(function() {
        $(".sweep_big_img").hide();

        $(".sweep_prompt").removeClass("hover");
    });
    $(".sendValidateCode").click(function() {
        mobile = $("#validMobile").val();
        sendValidateCode(mobile);
    })

});

function changedistrict(region_id) {
    var url = appUrl + "/Users/siteId/" + region_id;
    //alert(url);

    $.get(url, function() {
        alert(region_id);
        location.reload();
    });
}

//加入购物车效果
function addcart(imgsrc, x, y) {
    $("#floatOrder").remove();
    $('body').append('<div id="floatOrder"><img src="" width="36" height="36" /></div');
    $("#floatOrder").find("img").attr("src", "" + imgsrc + "");
    var X = $("#mini_cart").offset().left;
    var Y = $("#mini_cart").offset().top;
    $("#floatOrder").show();
    $("#floatOrder").css({
        'left': x,
        'top': y
    }).animate({
        'left': X,
        'top': Y + 50
    }, 500, function() {
        $("#floatOrder").animate({
            'left': X,
            'top': Y
        }, 200, function() {
            $("#floatOrder").fadeOut();

        });
    });
}
//弹窗页面

function Popshow(divId) {
    bodybg(395, 185);
    $(divId).show();
}

function openDialog(title, msg, closeText, closeCallback, confirmText, confirmCallback) {
    bodybg(395, 185);
    if (title == '') {
        title = '提示'
    };
    if (!closeText) closeText = '确定';
    var closeBtn = $("#dlg-close");
    closeBtn.text(closeText).one('click', function() {
        if (closeCallback && typeof(closeCallback) == 'function') {
            closeCallback();
        }
        closeDialog();
    });

    if (confirmText) {
        var confirmBtn = $("<div></div>").attr('id', 'dlg-confirm').addClass('btn_style_1 pop_btn').text(confirmText);
        confirmBtn.one('click', function() {
            if (confirmCallback && typeof(confirmCallback) == 'function') {
                confirmCallback();
            }
            closeDialog();
        });
    }
    $("#dlg-close").after(confirmBtn);
    $('#prompt_title').text(title);
    $('#prompt_msg_msg').text(msg);
    $('#prompt_msg').show();

}

function sendValidateCode(mobile) {
    postdata = {
        data: mobile
    }
    $.post(appUrl + '/Usercenter/sendValidateCode', postdata, function(result) {

    }, 'JSON').success(function(result) {
        openDialog('发送验证码', result.msg);
    });
}

function checkIn() {
    var url = appUrl + '/Usercenter/checkin';
    $.get(url, function(result) {
        if (result.code == 0) result.msg = '签到成功';
        openDialog('', result.msg);
    }, 'JSON');
}

function bodybg(Widths, Heights) {
    $aheight = $(document).height();
    $awidth = $(document).width();
    $docu = "<div id=\"bg\" style=\"opacity:0.7!important;filter:progid:DXImageTransform.Microsoft.Alpha(Opacity=70)!important;height:" + $aheight + "px;width:100%;max-width:120000px;position:absolute;left:0px;top:0px;background:#000;z-index:99;min-width:1200px;\"></div>";
    $("body").append($docu);


    aOffsetLeft = ($(window).width() / 2) - (parseInt(Widths) / 2);
    aOffsetTop = ($(window).height() / 2) - (parseInt(Heights) / 2);
    $(".login_register_main").css({
        "left": aOffsetLeft + "px",
        "top": aOffsetTop + "px"
    });
    $(".pop_main").css({
        "left": aOffsetLeft + "px",
        "top": aOffsetTop + "px"
    });
    $(".add_pop_main").css({
        "left": aOffsetLeft + "px",
        "top": aOffsetTop + "px"
    });

    $(window).resize(function() {
        aOffsetLeft = ($(window).width() / 2) - (parseInt(Widths) / 2);
        aOffsetTop = ($(window).height() / 2) - (parseInt(Heights) / 2);
        $(".login_register_main").css({
            "left": aOffsetLeft + "px",
            "top": aOffsetTop + "px"
        });
        $(".pop_main").css({
            "left": aOffsetLeft + "px",
            "top": aOffsetTop + "px"
        });
    });

}

function login(url) {
    if (url == null) {
        self.location.href = appUrl + "/Index/login";
    } else {
        self.location.href = appUrl + "/Index/login?url=" + url;
    }

}


function closelore_main() {
    $(".login_register_main").hide();
    $(".login_register_main").children().not(":first").hide();
    $("#bg").remove();
}

function Resize() {
    var winWidth = parseInt($(window).width());
    if (winWidth > 1190) {
        //$("#change_css").attr("class", "change_1190");
    } else {
        //$("#change_css").attr("class", "");
    }
}

//客服弹窗  
function ShowDialog() {
    var url = "http://qiao.baidu.com/v3/?module=default&controller=webim&action=index&siteid=3058791";
    var iWidth = 780; //窗口宽度         
    var iHeight = 550; //窗口高度          
    var iTop = (window.screen.height - iHeight) / 2 - 50;
    var iLeft = (window.screen.width - iWidth) / 2;
    window.open(url, "Detail", "Scrollbars=no,Toolbar=no,Location=no,Direction=no,Resizeable=no,Width=" + iWidth + " ,Height=" + iHeight + ",top=" + iTop + ",left=" + iLeft);
}

function forgetPasswordResponse(res) {
    var forgetTip = $(".forget-tip");
    forgetTip.html(res.msg);
    if (res.code == -1 && forgetTip.hasClass('Validform_wrong') == false) {
        forgetTip.addClass('Validform_wrong')
    } else if (res.code == 0) {
        forgetTip.removeClass('Validform_wrong');
    }
}

function closeDialog() {
    $(".pop_main").hide();
    $("#bg").remove();
    $("#dlg-confirm").remove();
}


function search() {
    searchname = $("#tb_search").val();
    if (searchname == null || searchname == '') {
        openDialog('提示', '搜索关键词不能为空');
        return;
    }


    url = appUrl + "/Search/index/searchname/" + searchname;
    window.location.href = url;
}


// 确认充值订单表单提交
function confirmRecharge() {
    order_amount = $("#order_amount").val();
    if (order_amount < 10 || order_amount > 50000) {
        openDialog('提示', '只能填写大于等于10，小于等于50000的整数金额');
        return;
    }

    $("#rechargeform").submit();
}

/**
 * 获取城市列表
 */
function loadCities() {
    var provinceId = parseInt($("#selProvince").val());
    var reqUrl = appUrl + '/Region/getChildrenRegion/pid/' + provinceId;
    $("#selDistricts").empty().hide();
    $.get(reqUrl,
        function(res) {
            fillRegionOpts('#selCity', res);
        }, 'JSON');
}


function loadDistricts() {
    var provinceId = parseInt($("#selProvince").val());
    var cityId = parseInt($("#selCity").val());
    var reqUrl = appUrl + '/Region/getChildrenRegion/pid/' + provinceId + '/cid/' + cityId;
    $.get(reqUrl,
        function (res) {
            fillRegionOpts('#selDistricts', res);
        }, 'JSON');
}

function fillRegionOpts(id, opts) {
    var render = template.compile(optshtml);
    $(id).html(function () {
        return render({options: opts});
    }).show()
}

/**
 * 获取发票单独寄送部分的城市列表
 */
function loadCities2() {
    var provinceId = parseInt($("#selProvince2").val());
    var reqUrl = appUrl + '/Region/getChildrenRegion/pid/' + provinceId;
    $("#selDistricts2").empty().hide();
    $.get(reqUrl,
        function(res) {
            fillRegionOpts('#selCity2', res);
        }, 'JSON');
}

/**
 * 获取发票单独寄送部分的城区列表
 */
function loadDistrict2() {
    var provinceId = parseInt($("#selProvince2").val());
    var cityId = parseInt($("#selCity2").val());
    var reqUrl = appUrl + '/Region/getChildrenRegion/pid/' + provinceId + '/cid/' + cityId;
    $.get(reqUrl,
        function(res) {
            fillRegionOpts('#selDistricts2', res);
        }, 'JSON');
}


function getPrdNum() {
    return $("#product_num").val();
}


function closeTab(id) {
    $("#" + id).hide();
}

//添加商品到购物车
function addToCart(ele) {
    var pid = $(ele).attr("data-pid");
    var prdNum = parseInt(arguments[1] ? arguments[1] : 1);
    var oldprdNum = parseInt($(".prd_num_" + pid).val());

    if (oldprdNum + prdNum > 99) {
        openDialog('', "单个商品数量不能超过100");
        return;
    }
    var product = {
        goods_number: prdNum,
        pid: pid
    };
    $.post(appUrl + '/Cart/addTocart', product, function(result) {
        var html = template("miniCart_js",result);
        if (document.getElementById("miniCart_html")) {
            document.getElementById("miniCart_html").innerHTML = html;    
        }        
        if(result.noLogin_jump == true){    //需要用户登陆的情况下，首先让用户登录
            window.location.href = '/Index/login';
        }else if (result.msg == "success") {
            var picsrc = $("#picsrc_" + pid).attr('src');
            if (picsrc != null && picsrc != '') {
                var x = $(ele).offset().left;
                var y = $(ele).offset().top;
                addcart(picsrc, x, y);
            }
            addtocart_response(result);
        } else if (result.msg == 'allsaled') {
            openDialog('提示', '您所拍的商品已售罄，请选择其他商品');
        } else if (result.msg == 'beyond') {
            openDialog('提示', '抱歉，每单限购' + result.limit + "份");
        } else if (result.msg == 'offsale') {
            openDialog('提示', '此商品已售罄，您暂时无法购买');
        } else if(result.msg == 'pruchase'){
            openDialog('抱歉', '此商品为限购商品，每人限购' + result.limit + '份');
        }else {
            openDialog('提示', '购物车内已经有啦，再抢店家就赔啦');
        }
    }, 'JSON');
}


function addtocart_response(result) {
    $(".cartTotal").html(result.cartTotal);
    $(".countPrd").html(result.countPrd);
    $(".minicart_num").html(result.countPrd);
    if (document.getElementById('itemList')) {
        document.getElementById('cartconnect').innerHTML = template('itemList', result);    
    }
        
  
    

}

//从购物车删除商品
function delCart(pid) {
    $.post(appUrl + '/Cart/removePrd', 'pid=' + pid, function(result) {
        if (result.msg == 0) {
            $(".item_" + pid).remove();
            delete_cartresponse(result);
        }
    }, 'JSON');
}

function delete_cartresponse(result) {
    if (result.msg == 0) {
        var html = template("miniCart_js",result);
        if (document.getElementById("miniCart_html")) {
            document.getElementById("miniCart_html").innerHTML = html;    
        }    
        $(".countPrd").html(result.countPrd);
        $(".cartTotal").html(result.cartTotal);
        $(".minicart_num").html(result.countPrd);
        if (document.getElementById('itemList')) {
            document.getElementById('cartconnect').innerHTML = template('itemList', result);    
        }       
    }

}


function min_intval_filter(goods_number) {
    if (isNaN(goods_number)) {
        goods_number = 1;
    }
    goods_number = parseInt(Math.ceil(goods_number));
    if (goods_number < 1) {
        goods_number = 1;
    } else if (goods_number > 100) {
        goods_number = 100
    }
    return goods_number;
}

//+-改变购物车中的数量
function changeCartNum(rec_id, diff) {
    //openDialog('','0');
    var min_prd_number = parseInt($('#min_goods_number_' + rec_id).val());
    min_prd_number = min_intval_filter(min_prd_number);
    //openDialog('','1 min_prd_number=' + min_prd_number);
    min_prd_number = min_prd_number + diff;
    //	openDialog('','2 min_prd_number=' + min_prd_number);
    if (min_prd_number < 1) {
        //openDialog('','ok');
        pid = $("#min_goods_number_" + rec_id).attr("data-pid");
        delCart(pid);
    } else if (min_prd_number > 100) {
        return;
    } else {
        //$.post('Cart/modifyPrdNum', 'rec_id=' + rec_id +'&goods_number=' + min_prd_number, min_change_prd_number_response,'JSON');                
        $.post(appUrl + '/Cart/modifyPrdNum', 'rec_id=' + rec_id + '&goods_number=' + min_prd_number, function(result) {
            min_change_prd_number_response(result);
        }, 'JSON');
    }
    //  min_change_prd_number(rec_id, min_prd_number);

}


function min_change_prd_number(rec_id, min_prd_number) {

    min_prd_number = min_intval_filter(min_prd_number);
    // $(".bigcart_num").val(min_prd_number);
    //openDialog('','4 min_prd_number=' + min_prd_number);
    $.post(appUrl + '/Cart/modifyPrdNum', 'rec_id=' + rec_id + '&goods_number=' + min_prd_number, function(result) {
        min_change_prd_number_response(result);
    }, 'JSON');

}

function min_change_prd_number_response(result) {


    if (result.msg == "success") {
        // openDialog('',"sd");
        $("#cart_main").html(result.cart_list);
        $("#cartconnect").html(result.big_cart_list);
        $("#countprd").html(result.countPrd);
        $(".minicart_num").html(result.countPrd);
        $(".right span").html("￥" + result.cartTotal);
        $("#cartfee").html("￥" + result.cartTotal);
        $("#credit").html(parseInt(result.cartTotal));

        if (parseInt(result.needFreeMoney) > 0) {
            $("#shiptip").css("display", "block");
            $("#need_money").html(result.needFreeMoney);
        } else {
            $("#shiptip").css("display", "none");
        }

        $(".minicart").show();
        var html = template('itemList', result);
        document.getElementById('cartconnect').innerHTML = html;
    }

}


//------------ 结算页-------------//

//增加新地址
function save_consignee() {
    var data = {
        act: 'add',
        adr_id: $("#adr_id").val(),
        consignee: $("#consignee").val(),
        province: $("#selProvince").val(),
        city: $("#selCity").val(),
        district: $("#selDistricts").val(),
        address: $("#address").val(),
        mobile: $("#mobilephone").val()
    }

    var reg = /^([\w\u4e00-\u9fa5]{1,20})$/g;
    if (data.consignee == '') {
        openDialog('', "收货人姓名不能为空")
        return;
    }

    if (reg.test(data.consignee) == false) {
        openDialog('', '收货人的格式不正确');
        return;
    }

    if (data.province == 0) {
        openDialog('', '请选择城市');
        return;
    }
    if (data.city == 0) {
        openDialog('', '请选择省份');
        return;
    }
    if (data.district == 0) {
        openDialog('', '请选择区域');
        return;
    }


    if (data.address == '') {
        openDialog('', '收货地址不能为空');
        return;
    }

    if (data.mobile == '') {
        openDialog('', '手机号不能为空');
        return;
    }

    var reg = /^1[34578]\d{9}$/g; //手机号码的验证 11位，
    if (reg.test(data.mobile) == false) {

        openDialog('', '手机的格式不正确');
        return;
    }
    if ($("#selDistricts").is(":hidden")) {
        openDialog('', "请选择区域");
        return;
    }

    $.post(appUrl + '/Flow/consigneeOperateInfo', data, function(res) {
        add_consignee_response(res);
    }, 'JSON');


}


function add_consignee_response(res) {
    if (res.msg == "success") {
        $("#hgs_consignee").html(res.consignee_list);
        $("#pay_ment").html(result.paynship);
        setShippingTime(result.timestamp);
        $("#consignee_list_radio,#save_to_address,#payment_ship_text,#save_conignee_before").hide();
        $("#address_change,#address_abstract,#pay-ship-info,#save_to_payment").show();
        $("#pay_ment").attr("class", "choice_this");
        $("#hgs_consignee").attr("class", "checkout_box");
    }

}


function delete_consignee(adr_id) {

    $.post(appUrl + '/Flow/consigneeOperateInfo', 'adr_id=' + adr_id + '&act=drop', function(result) {
        delete_consignee_response(result);
    }, 'JSON');

}

function delete_consignee_response(result) {
    if (result.msg == "success") {
        $("#hgs_consignee").html(result.consignee_list);
    }

}



function update_consignee(adr_id) {

    $(".consignee_" + adr_id).prop("checked", true);
    var data = {
        act: 'update',
        adr_id: adr_id,
        consignee: $("#consignee").val(),
        province: $("#selProvince").val(),
        city: $("#selCity").val(),
        district: $("#selDistricts").val(),
        address: $("#address").val(),
        mobile: $("#mobilephone").val()
    }
    $.post(appUrl + '/Flow/consigneeOperateInfo', data, function(result) {
        update_consignee_response(result);
    }, 'JSON');

}

function update_consignee_response(result) {
    $("#hgs_consignee").html(result.consignee_list);
    $("#new_address_main,#save_address,#selDistricts").show();
    //$("#hgs_consignee").removeClass("class","checkout_box");
    $("#hgs_consignee").attr("class", "choice_this");
    $("#set_address").hide();
}

function setAddress() {

    id = $(".user_consignee_list:checked").val();
    setSelectedAddress(id);
}

//确认选择的地址
function setSelectedAddress(addressId) {

    address_absctract = $("#address_" + addressId).val();
    $("#address_abstract").text(address_absctract).show();
    $("#consignee_list_radio,#save_to_address,#save_conignee_before,#payment_ship_text").hide();
    //$("#address_text_save,#pay-ship-info,#save_to_payment").show();
    //$("#pay_ment").attr("class", "choice_this");
    $("#hgs_consignee").attr("class", "checkout_box");
    $.post(appUrl + '/Flow/consigneeOperateInfo', 'adr_id=' + addressId + '&act=update', function(result) {
        set_consignee_response(result);
    }, 'JSON');
}

function set_consignee_response(result) {
    if (result.msg == "success") {
        updateFeeSummary(result);


        $("#cityName").text(result.province_name);
        if (result.checkresponsecode == 0) {
            checkcartproduct();
            $("#payment_ship_text").show();
            $("#address_change").click();
            return false;
        }
        $("#pay_ment").html(result.paynship);
        setShippingTime(result.timestamp);
        $("#payment_ship_text").hide();
        $("#address_text_save,#pay-ship-info,#save_to_payment").show();
        $("#pay_ment").attr("class", "choice_this");
        $("#hgs_consignee").attr("class", "checkout_box");
        $("#save_conignee_before").hide();
    }
}


function updateFeeSummary(result) {
    $("#goods-fee").text('￥' + result.goods);
    $("#shipping-fee").text('￥' + result.shipping);
    $("#invoice-fee").text('￥' + result.invoice);
    $("#bonus-deduct").text('￥' + result.bonus);
    $("#card-deduct").text('￥' + result.giftcard);
    $("#credit-deduct").text('￥' + result.credit);
    $("#amount_formated").text('￥' + result.amount)
}

function setShippingTime(timestamp) {
    timestamp = parseInt(timestamp);
    var tday = (timestamp + 86400) * 1000;
    var tmr = (timestamp + 86400 * 2) * 1000;
    var dat = (timestamp + 86400 * 3) * 1000;
    var dd = new Date(tday);
    var h = dd.getHours();
    dd.getDate();
    var y = dd.getFullYear() + "-";
    var m = dd.getMonth() + 1 + "-";
    var d = dd.getDate() + "（明天）";
    var tod = new Date(tmr);
    var y1 = tod.getFullYear() + "-";
    var m1 = tod.getMonth() + 1 + "-";
    var d1 = tod.getDate() + "（后天）";
    var dot = new Date(dat)
    var y2 = dot.getFullYear() + "-";
    var m2 = dot.getMonth() + 1 + "-";
    var d2 = dot.getDate() + "（大后天）";
    $("#time_one_am").text(y + m + d + "09:00-18:00");
    $("#time_one_pm").text(y + m + d + "18:00-22:00");
    $("#time_two_am").text(y1 + m1 + d1 + "09:00-18:00");
    $("#time_two_pm").text(y1 + m1 + d1 + "18:00-22:00");
    $("#time_three_am").text(y2 + m2 + d2 + "09:00-18:00");
    $("#time_three_pm").text(y2 + m2 + d2 + "18:00-22:00");

    if (h > 22) {
        $("#time_one_am").hide();
    } else {
        $("#time_one_am").show();
    }
}

function check_payment() {
    var payment = $('input[name="payment"]:checked').val();
    if (payment == undefined) {
        openDialog('', '请选择支付方式');
    }

    if (payment >= 1 || payment.length > 2) {

        if (payment == 1) {
            paymentText = '货到付款';
            var times_text = $("#times_list").find("option:selected").text();

        } else if (payment == 2) {
            paymentText = '支付宝';
            var times_text = $("#times_list option:selected").text();

        } else {
            paymentText = '网上银行在线支付';
            var times_text = $("#times_list").find("option:selected").text();
        }
        var shipping = $('input[name="shipping_id"]:checked').attr("sname");
        //alert(shipping);
        if (shipping == "顺丰快递") {
            shippingText = shipping;
        } else {
            if (times_text == "任意时间") {
                shippingText = "花果山物流默认时间配送";
            } else {
                shippingText = "花果山物流将于以下时间为您配送：" + times_text;
            }
        }
        $("#ship_text").text(shippingText).show();
        $("#pay-ship-info,#save_to_payment,#address_text_save,#invoiceInfoTexignee_before").hide();
        $("#payment_ship_text,#payment_change,#address_change").show();
        $("#payment_text").text(paymentText).show();

    }
    $("#pay_ment").attr("class", "checkout_box");
    $("#address_text_save,#save_conignee_before").hide();
    $("#address_change").show();
}

function re_comment(id) {
    divid = "recomment_form_" + id;
    if ($(".need_login").size() < 0) {
        return false;
    }
    $("[data-id=" + divid + "]").toggle();
}

function selectBonus(val) {
    var postdata = {
        bonus_id: val
    }
    $.post(appUrl + "/Flow/selectBonus", postdata, function(result) {
        dealDeductInfo(result);
        updateFeeSummary(result);
        $("#bonus_id").val(val);
        $(".use-bonus").removeClass('disabled').text('使用');
        $(".bonus-btn-" + val).addClass('disabled').text('已使用');
        $("#bonus_main").hide();
        $("#bonus_img").removeClass("toggle_title_img_hover");
    }, 'JSON');
}

function dealDeductInfo(result) {
    var bcText = pointText = giftcardtext = "";
    var bonus_tips = giftcard_tips = credit_tips = "";
    if (parseInt(result.bonus) > 0) {
        bcText = '使用优惠券抵扣:￥' + result.bonus;
        $("#discount_bonus_tip").show();
    } else {
        $(".use-bonus").removeClass('disabled').text('使用');
        $("#discount_bonus_tip").hide();
    }
    if (parseInt(result.giftcard) > 0) {
        giftcardtext = ' 使用礼品卡抵扣:￥' + result.giftcard;
        giftcard_tips = "取消已使用的礼品卡：请取消已选中的礼品卡后点击使用，即可取消。";
    }
    if (parseInt(result.credit) > 0) {
        if (!result.usePoint) {
            result.usePoint = parseInt(result.credit) * 100;
        }
        credit_tips = "取消已使用的积分：请将积分输入数改为0后点击使用，即可取消。";
        pointText = '使用 ' + result.usePoint + ' 积分抵消￥' + result.credit;
    }
    $("#bc-deduct").text(bcText);
    $('#integralAmount').text(pointText);
    $("#bc-giftcard").text(giftcardtext);

    $("#discount_giftcard_tip").text(giftcard_tips);
    $("#discount_credit_tip").text(credit_tips);

}

function goodsRecomment(frm) {
    var cmt = new Object;
    cmt.re_username = $(frm).children("#re_username").val();
    cmt.content = $(frm).children("#content").val();
    cmt.parent_id = $(frm).children("#parent_id").val();
    cmt.uid = $(frm).children("#uid").val();
    cmt.username = $(frm).children("#username").val();
    cmt.gid = $(frm).children("#gid").val();
    //    openDialog('',cmt.parent_id);
    if (cmt.content.length == 0) {
        openDialog('', '评论内容不能为空！');
        return false;
    }
    if (cmt.content.length < 20) {
        openDialog('', '评论内容不能少于20！');
        return false;
    }
    // openDialog('','goodsRecomment re_username' + cmt.re_username + ' parent_id' + cmt.parent_id);
    // Ajax.call('comment.php', 'act=recomment&cmt=' + $.toJSON(cmt), goodsRecommentResponse, 'POST', 'JSON');
    // return false;
    /* if(cmt.content == '') {
     return  false;
     }*/
    $.post(appUrl + "/Product/reComment", {
            re_username: cmt.re_username,
            parent_id: cmt.parent_id,
            content: cmt.content,
            uid: cmt.uid,
            username: cmt.username,
            gid: cmt.gid
        },
        function(res) {
            goodsRecommentResponse(res);
        }, 'JSON');

}

/**
 * wwz edit 商品详情页回复评论
 */
function goodsRecommentResponse(result) {
    if (result.msg == "success") {
        $("[name=content]").val("");
        $("#product_comment_list").html(result.body);
        $("#product_comment_list2").html(result.body);
        $(".product_tab li")[1].click();
        openDialog('', '十分感谢您的参与，您的评论审核后方可显示！');
    }
}


//对发票系列的输入框进行正则验证

function checke_invoice() {

    var need_invoice = $('input[name="need_invoice"]:checked').val();
    var need_addr = $('input[name="inv_need_addr"]:checked').val();
    var inv_type = $('input[name="inv_type"]:checked').val();
    var inv_payee = $.trim($("#inv_payee").val());
    var inv_content = $("#inv_content").find("option:selected").text();
    var inv_username = $.trim($("#inv_consignee").val());
    var inv_address = $.trim($("#inv_address").val());
    var inv_phone = $.trim($("#inv_phone").val());
    var invoice_text = "不需要发票";
    if (need_invoice == 1) { //如果需要发票

        if (inv_payee != '') { //如果发票抬头不为空
            var reg = /^([\w\(\)\（\）u4e00-\u9fa5]{1,200})$/g; //发票抬头,
            if (reg.test(inv_payee) == false) {
                openDialog('', '发票格式不正确');
                return;
            }
            invoice_text = "发票抬头：" + inv_payee;
        } else {

            openDialog('', '发票抬头不能为空');
            return;

        }
        if (need_addr == 1) { //如果需要寄送发票
            invoice_text += " 发票另外寄送，加收￥10";
            if (inv_username != '') {

                var reg = /^([\w\u4e00-\u9fa5]{1,20})$/g;

                if (reg.test(inv_username) == false) {
                    openDialog('', '发票收货人姓名的格式不正确');
                    return;
                }
            } else {

                openDialog('', '发票收货人姓名不能为空');
                return;
            }

            /*if (selProvincess == 0) {
             openDialog('', '请选择省份');
             return;
             }
             if (selCitiess == 0) {
             openDialog('', '请选择城市');
             return;

             }
             if (selDisctrictss == 0) {
             openDialog('', '请选择区域');
             return;
             }*/
            if (inv_address == '') {
                openDialog('', '收货地址不能为空');
                return;
            }
            if (inv_phone != '') {
                var reg = /^1[34578]\d{9}$/g; //手机号码的验证 11位，
                if (reg.test(inv_phone) == false) {

                    openDialog('', '手机号码格式不正确');
                    return;
                }

            } else {

                openDialog('', '手机号码不能为空');
                return;

            }
        }
    }

    $("#invoiceInfoText").text(invoice_text).show();
    $("#receipt_main").hide();
    $("#receipt_id").removeClass("toggle_title_img_hover");

}

//使用积分

function change_integral() {
    var integral_use_most = parseInt($("#integral_use_most").text());
    var integral = $('#integral').val();
    if (integral != '') {
        var reg = /^\d+$/g;
        integral = parseInt(integral);
        if (reg.test(integral) == false) {
            $('#integral').val(0);
            $("#integralAmount").text('');
            openDialog('', "积分只能为数字");
            return;
        } else if (integral % 100 != 0) {
            $('#integral').val(0);
            //openDialog('',"积分只能是100的倍数");
        } else if (integral == 0) {
            $("#integral_main").hide();
            $("#integral_img").removeClass("toggle_title_img_hover");
        } else if (integral > integral_use_most) {
            $('#integral').val(0);
            $("#integralAmount").text('');
            return;
        }
    } else {
        openDialog('', '积分不能为空');
        return;
    }
    var postdata = {
        pay_point: integral
    }
    $.post(appUrl + '/Flow/useCredit', postdata, function(result) {
        change_integral_response(result);
    }, 'JSON');


}

function change_integral_response(result) {
    if (result.msg == "success") {
        dealDeductInfo(result);
        updateFeeSummary(result);
        $("#integral_main").hide();
        $("#integral_img").removeClass("toggle_title_img_hover");
    } else {
        openDialog('', result.msg);
        return false;
    }
}

function invoiceNeedShipping() {

    var val = $('#receipt_address_yes:checked').val();
    val = parseInt(val);
    $.post(appUrl + '/Flow/invoiceNeedShipping', 'needvoice=' + val, function(result) {
        updateFeeSummary(result);
    }, 'JSON');

}

//提交订单验证
function Validform() {
    var openTab = $(".choice_this");
    if (openTab.length > 0) {
        openDialog('', '请先确认订单配送支付信息');
        return false;
    }
    var extTab = $('.toggle_title_img_hover');
    if (extTab.length > 0) {
        openDialog('', '请先确认订单优惠及发票信息');
        return false;
    }
    checkcartproduct();
    return true;
}

function newAddress() {
    $("#adr_id").val(0);
    $("#consignee,#address,#mobile").val('');
    $("#new_address_main,#save_address").show();
    $("#set_address").hide();
}

function save_user_address() {
    // 获取省市区
    var prov_id = $('#provinces').children('option:selected').val();
    var city_id = $('#cities').children('option:selected').val();
    var district_id = $('#districts').children('option:selected').val();
    var consignee = $('#consignee').val();
    var address = $('#address').val();
    var mobile = $('#mobile').val();
    var default_addr = $('#default_addr').is(':checked') ? 1 : 0;
    // alert('consignee='+consignee+' prov_id='+prov_id+'city_id='+city_id+' district_id='
    //         +district_id+' address='+address+' mobile='+mobile+' default_addr='+default_addr);
    if (consignee == '') {
        openDialog('', '收件人不能为空');
        return;
    }
    if (address == '') {
        openDialog('', '详细地址不能为空');
        return;
    }
    if (mobile == '') {
        openDialog('', '手机号码不能为空');
        return;
    }
    var postdata = {
        'consignee': consignee,
        'province': prov_id,
        'city': city_id,
        'district': district_id,
        'address': address,
        'mobile': mobile,
        'default_addr': default_addr
    }
    $.post(appUrl + "/Usercenter/saveUserAddressSelection", postdata, function(res) {
        save_user_addressResponse(res);
    }, 'JSON');
}

function registerResponse(result) {

    if (result.code == 0) {
        signPageJump();
    } else {
        $("#register_main .login_prompt_1").text('该用户名已被注册');
        $("input[name='register_password']").val('');
        var src = $('#verifyImg').attr('src')+'?'+Math.random();
    	$('#verifyImg').attr('src',src);
    }
}

function save_user_addressResponse(res) {
    switch (res.code) {
        case 0:
            openDialog('', "保存用户地址成功");
            location.href = appUrl + "/Usercenter/userAddress";
            break;
        case 20011:
            openDialog('', "用户不存在");
            break;
        case 20002:
            openDialog('', "省、市、区不存在");
            break;
    }
}


function update_user_address() {
    // 获取省市区
    var prov_id = $('#provinces').children('option:selected').val();
    var city_id = $('#cities').children('option:selected').val();
    var district_id = $('#districts').children('option:selected').val();
    var consignee = $('#consignee').val();
    var address = $('#address').val();
    var mobile = $('#mobile').val();
    var default_addr = $('#default_addr').is(':checked') ? 1 : 0;
    // openDialog('','consignee='+consignee+' prov_id='+prov_id+'city_id='+city_id+' district_id='
    //         +district_id+' address='+address+' mobile='+mobile+' default_addr='+default_addr);
    if (consignee == '') {
        openDialog('', '收件人不能为空');
        return;
    }
    if (address == '') {
        openDialog('', '详细地址不能为空');
        return;
    }
    if (mobile == '') {
        openDialog('', '手机号码不能为空');
        return;
    }

    var reg = /^1[34578]\d{9}$/g; //手机号码的验证 11位，
    if (reg.test(mobile) == false) {
        openDialog('', '手机的格式不正确');
        return;
    }
    var postdata = {
        'consignee': consignee,
        'province': prov_id,
        'city': city_id,
        'district': district_id,
        'address': address,
        'mobile': mobile,
        'default_addr': default_addr
    }
    $.post(appUrl + "/Usercenter/ajaxUpdateAddress", postdata, function(res) {
        update_user_addressResponse(res);
    }, 'JSON');
}


function update_user_addressResponse(res) {
    switch (res.code) {
        case 0:
            openDialog('', "修改用户地址成功");
            location.href = appUrl + "/Usercenter/userAddress";
            break;
        case 20011:
            openDialog('', "用户不存在");
            break;
        case 20002:
            openDialog('', "省、市、区不存在");
            break;
    }
}


//手机，邮箱格式验证
function isMobile_Email(value) {
    var m1 = new RegExp(/^13\d{9}$/g);
    var m2 = new RegExp(/^15[0-35-9]\d{8}$/g);
    var m3 = new RegExp(/^14[0-35-9]\d{8}$/g);
    var m4 = new RegExp(/^17[01-9]\d{8}$/g);
    var m5 = new RegExp(/^18[01-9]\d{8}$/g);

    var e1 = new RegExp(/^([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\_|\.]?)*[a-zA-Z0-9]+\.[a-zA-Z]{2,3}$/);

    if (m1.test(value) || (m2.test(value)) ||
        (m3.test(value)) || (m4.test(value)) || (m5.test(value))
    ) {
        return true;

    } else if (e1.test(value)) {
        return true;
    } else {
        return false;
    }
}

//登录或注册后页面跳转
function signPageJump() {
    var url = $("#signJumpPage").val();
    if (url == "") {
        location.reload();

    }

    window.location.href = url;
}

//用户登录反馈函数
function signInResponse(result) {
    if (result.code == 0) {
        signPageJump();
        return;
    }
    if(result.info)
    	$("#errortext").text(result.info);
    else{
    	$("#errortext").text('请输入正确的账号密码');
    	$("input[name='login_password']").val('');
    }
    if(result.login_check_yzm >= 3){
    	$('#validate_main').show();
    	var src = $('#login_yzm').attr('src')+'?'+Math.random();
    	$('#login_yzm').attr('src',src);
    	$("input[name='login_password']").val('');
    }
}


//wwz Usercenter用户更新资料
function updateUserInfo() {

    var nickname = $("[name=nickname]").val();
    var birthday = $("#d11").val();
    if (nickname != '') {
        nickname = $.trim(nickname);
    }

    /*  birthday = birthday.toString(birthday);
     var birthdayYear = $("#birthYear").find("option:selected").text();
     var birthdayMonth = $("#birthMonth").find("option:selected").text();
     var birthdayDay = $("#birthDay").find("option:selected").text();
     var birthdayYear = birthday.substring(0,4);
     var birthdayMonth = birthday.substring(6,7);
     var birthdayDay = birthday.substring(9,10);
     */

    // 处理错误年月日问题，2月不能有30号  4月不能有31号
    /*var birthdayOK = true;
     if (birthdayMonth != 1 && birthdayMonth != 3 && birthdayMonth != 5 && birthdayMonth != 7 && birthdayMonth != 8 && birthdayMonth != 10 && birthdayMonth != 12 && birthdayDay == 31) {
     birthdayOK = false;
     }
     if (!isLeapYear(birthdayYear) && birthdayMonth == 2 && birthdayDay > 28) {
     birthdayOK = false;
     }
     if (!birthdayOK) {
     openDialog('', '出生日期错误');
     return;
     }*/
    if (nickname != '') {
        var postdata = {
            'nickname': nickname,
            'birthday': birthday
            /*'birthdayYear': birthdayYear,
             'birthdayMonth': birthdayMonth,
             'birthdayDay': birthdayDay*/
        }
    }

    $.post(appUrl + "/Usercenter/updateUserInfo", postdata, function(res) {
        updateUserInfoResponse(res);
    }, 'JSON');
}

function isLeapYear(year) {
    if ((year % 4 == 0 && year % 100 != 0) || (year % 400 == 0)) return true;
    else return false;
}

//wwz Usercenter更新资料反馈函数
function updateUserInfoResponse(res) {
    switch (res.code) {
        case 0:
            openDialog('', '更新成功');
            //location.reload();
            break;
        case 20011:
            openDialog('', '用户不存在');
            break;
        case 20012:
            openDialog('', '有非法字符');
            break;
        case 20018:
            openDialog('', '获取用户信息失败');
            break;
        case 20051:
            openDialog('', '日期错误');
            break;
        case 20013:
            openDialog('', '保存成功');
            break;
    }
}


//wwz Usercenter用户修改密码
function updatePassword() {

    var oldpassword = $("[name=oldpassword]").val();
    var password = $("[name=password]").val();
    var password2 = $("[name=password2]").val();

    if (oldpassword === "" || password === "" || password2 === "") {
        openDialog('', "密码不能为空");
        return;
    } else if (password != password2) {
        openDialog('', "两次密码输入不正确");
        return;
    } else {
        if (password.length > 16 || password.length < 7) {
            openDialog('', "密码过长或过短");
            return;
        };
        md5_oldpassword = hex_md5(oldpassword);
        md5_password = hex_md5(password);
        var postdata = {
            oldpassword: md5_oldpassword,
            password: md5_password
        }
        $.post(appUrl + "/Usercenter/updatePassword", postdata, function(res) {
            updatePasswordResponse(res);
        }, 'JSON');
    }
}

//wwz Usercenter用户修改密码反馈
function updatePasswordResponse(res) {
    switch (res.code) {
        case 0:
            openDialog('', "修改成功");
            break;
        case 20011:
            openDialog('', "用户不存在");
            break;
        case 20012:
            openDialog('', "有非法字符");
            break;
        case 20013:
            openDialog('', "修改失败");
            break;
        case 20020:
            openDialog('', "原密码错误");
            break;
    }
}

//Usercenter用户设置默认地址
function setDefaultAddress(addr_id) {
    postdata = {
        addr_id: addr_id
    }
    $.post(appUrl + "/Usercenter/setDefaultAddress", postdata, function(res) {
        setDefaultAddressResponse(res);
    }, 'JSON');
}

//Usercenter用户设置默认地址反馈
function setDefaultAddressResponse(res) {
    switch (res.code) {
        case 0:
            openDialog('', "修改成功");
            break;
        case 20003:
            openDialog('', "地址不存在");
            break;
        case 20008:
            openDialog('', "地址不属于该用户");
            break;
    }
}

//Usercenter用户删除地址
function deleteAddress() {
    var obj = document.getElementsByName('addr_id[]'); //选择所有name="'addr_id'"的对象，返回数组    
    var k = 0;
    //取到对象数组后，循环检测它是不是被选中 
    for (var i = 0; i < obj.length; i++) {
        if (obj[i].checked) {
            k++;
        }
    }
    if (k == 0) {
        openDialog('', "未选中任何地址");
        return false;
    }
    document.getElementById('adlist').submit();
}

function cancelOrderDialog(orderId) {
    openDialog('', '您确认要取消此订单?', '关闭', null, '确定', function() {
        cancelOrder(orderId);
    });
}

function cancelOrder(orderId) {
    if (!orderId) return false;
    $.get(appUrl + '/Usercenter/cancelOrder/oid/' + orderId, function(res) {
        cancelOrderResponse(res);
    }, 'JSON');
}

function cancelOrderResponse(res) {
    if (res.code == 0) {
        openDialog('', '取消订单成功', null, function() {
            location.reload();
        });
    } else {
        openDialog('', res.msg);
    }
}

//Usercenter用户激活优惠券
function activateBonus() {
    var bonus_code = $("[name=bonus_code]").val();

    if (bonus_code === "") {
        openDialog('', "优惠券激活码不能为空");
    } else {
        var postdata = {
            bonus_code: bonus_code
        }
        $.post(appUrl + "/Usercenter/activateBonus", postdata, function(res) {
            activateBonusResponse(res);
        }, 'JSON');
    }
}

function sendCoupon() {
    var type_id = $("#type_id").val();
    $.post(appUrl + "/Users/activateBonus", "type_id=" + type_id, function(res) {
        sendCouponResponse(res);
    }, "JSON")

}

function sendCouponResponse(res) {
    switch (res.code) {
        case 0:
            openDialog('', "激活成功");
            break;
        case 70013:
            openDialog('', "您已经激活了该优惠券,无需重复激活");
            break;
        case 70012:
            openDialog('', "优惠券已过期");
            break;
    }
}
//Usercenter用户激活优惠券反馈
function activateBonusResponse(res) {
    switch (res.code) {
        case 0:
            openDialog('', "激活成功");
            location.reload();
            break;
        default:
            openDialog('', res.msg);
            break;
    }
}


//Usercenter用户激活礼品卡
function activateGiftcard() {
    var gc_key = $("[name=gc_key]").val();
    var verify = $("[name=verify]").val();

    if (gc_key === "") {
        openDialog('', "卡号不能为空");
        return false;
    } else if (verify === "") {
        openDialog('', "验证码不能为空");
        return false;
    } else {
        var postdata = {
            gc_key: gc_key,
            verify: verify
        }
        $.post(appUrl + "/Usercenter/activateGiftcard", postdata, function(res) {
            activateGiftcardResponse(res);
        }, 'JSON');
    }
}


//Usercenter用户激活礼品卡反馈
function activateGiftcardResponse(res) {
    switch (res.code) {
        case 0:
            openDialog('', "激活成功");
            location.reload();
            break;
        case -1:
            openDialog('', "验证码错误");
            break;
        case 70110:
            openDialog('', "礼品卡激活码不存在");
            break;
        case 70111:
            openDialog('', "礼品卡已过期");
            break;
        case 70112:
            openDialog('', "礼品卡未售出");
            break;
        case 70115:
            openDialog('', "礼品卡已激活");
            break;
        default:
            openDialog('', res.errmsg);
    }
}

//刷新验证码
function updateVerify() {

    document.getElementById('verifyImg').src = appUrl + '/Users/verify/' + '?' + Math.random();
}

function cplink() {
    var str = $("#user-invite-link").val();
    if (window.clipboardData) {
        window.clipboardData.clearData();
        window.clipboardData.setData("Text", str);
        alert("复制成功！");
    } else {
        alert("浏览器不支持自动复制,请手动复制文本框的内容")
    }
}

//登录注册
function userlogin() {
    $(".tab_main div").removeClass("click_change");
    $(".tab_main .left").addClass("click_change");
    $(".tab_border_status div").hide();
    $(".tab_change_status_left").show();
    $("#register").hide();
    $("#login").show();
    $(".login_findpass a").text("忘记登录密码？");
    $(".register_change a").text("免费注册");
    $('.login_bottom').show();
}

function userregister() {
    $(".tab_main div").removeClass("click_change");
    $(".tab_main .right").addClass("click_change");
    $(".tab_border_status div").hide();
    $(".tab_change_status_right").show();
    $("#login").hide();
    $("#register").show();
    $(".login_findpass a").text("");
    $(".register_change a").text("");
    $('.login_bottom').hide();	//新增隐藏
}

function checkcartproduct() {
    /*var pid = $("input[name='pid[]']");
     var pids = [];
     for(var i = pid.length-1;i>=0;i--) {
     pids[i] = $(pid[i]).val();
     }
     console.log(pids);*/

    var url = appUrl + "/Product/checkStockProduct";
    $.post(url, '', function(result) {
        if (result.code == 0) {
            $("#checkstock").html(result.content);
            openshow();
        }
    }, "JSON");

    return false;

}

function checkchangepayment() {
    //var payment = $(":radio:checked").val();
    var payment = $('#change_pay_bank_img').attr('src');
    if (payment == '') {
    	openDialog('', "请选择支付方式");
        return false;
    } else {
    	return true;
    }
}

function openshow() {
    bodybg(784, 285);
    $("#checkstock").show();

}

function removewin() {
    $(".add_pop_main").hide();
    $("#bg").remove();
}

function updatestockaddress() {
    $(".add_pop_main").hide();
    $("#bg").remove();
    $("#address_change").click();
}

function pagecomment(i) {
    var gid = $("#cgid").val();
    var pid = $("#cpid").val();
    $.get(appUrl + "/Product/pagecomment?page=" + i + "&gid=" + gid + "&pid=" + pid,
        function(result) {
            $(".product_comment_list").html(result);
        }, "json");
}

setTimeout('topguanggao()', 3000);

function topguanggao() {

    $(".hgs_guanggao_big").animate({
        "height": "100px"
    }, 600, function() {
        $(".hgs_guanggao_big").animate({
            "height": "0px"
        });
    })

    $(".hgs_guanggao").animate({
        "height": "100px"
    }, 600);


}

function exchange() {
    var vsn = $.trim($("#vouchersn").val());
    var consignee = $.trim($("#consignee").val());
    var province = parseInt($("#selProvince").val());
    var city = parseInt($("#selCity").val());
    var district = parseInt($("#selDistricts").val());
    var address = $.trim($("#address").val());
    var mobile = $.trim($("#mobile").val());
    if (vsn == "") {
        openDialog('', '请输入提货码');
        return false;
    }
    if (consignee == "" || address == "" || mobile == "" || province == -1 || city == -1 || district == -1) {
        openDialog('', '请完善收货信息');
        return false;
    }
    var reg = /^1[34578]\d{9}$/g;
    if (reg.test(mobile) == false) {
        openDialog('', '请输入正确的手机号码');
        return false;
    }
    return true;
}

function formatTime(){
    $(".toTime").each(function(idx, val) {
        var timestamp = $(val).text();
        $(val).text(moment.unix(timestamp).format('YYYY-MM-DD HH:mm:ss'));
    });
}


